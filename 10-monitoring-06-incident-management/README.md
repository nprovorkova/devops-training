### 10.6. Инцидент-менеджмент - Наталия Проворкова
#### 1. Составьте постмотрем, на основе реального сбоя системы Github в 2018 году. Информация о сбое доступна в виде [краткой выжимки на русском языке](https://habr.com/ru/post/427301), а также [развёрнуто на английском языке](https://github.blog/2018-10-30-oct21-post-incident-analysis).
###### Постмортем
| Раздел      |Описание    |
|         ---:|:---        |
| Краткое описание инцидента | 21 октября 2018 года в GitHub произошел инцидент, который привел к снижению качества обслуживания на 24 часа 11 минут. Никакие пользовательские данные не были потеряны.   |
| Предшествующие события   |21 октября в 22:52 UTC проводились регламентные работы по замене вышедшего из строя оптического оборудования.  |
| Причина инцидента   |В результате работ по замене оптического оборудования была потеряна связь между ЦОДами. Связь была восстановлена за 43 секунды, но кратковременный сбой вызвал цепочку событий, которые привели к ухудшению качества обслуживания на 24 часа 11 минут.  |
| Воздействие   |Отображалась устаревшая и непоследовательная информация. Github не мог обслуживать вебхуки, не мог билдить и публиковать GitHub Pages. |
| Обнаружение   |Внутренние системы мониторинга начали указывать на многочисленные сбои в системах.      |
| Реакция   | Были вызваны инженеры из группы разработки БД GitHub. |
| Восстановление   |Остановлены веб-хуки и сборки GitHub Pages, восстановлены резервные копии, синхронизированы реплики, обработаны веб-хуки из очереди.    |
| Таймлайн   |21.10.2018 22:52 UTC Произошло временное отключение основного Восточного ЦОДа, все запросы перенаправились в Западный. После восстановления Восточного ЦОДа, он содержал данные, которые не были реплицированы, оба кластера содержали данные для записи, отсутствующие в другом ЦОДе, невозможно было выполнить безопасное восстановление данных. <br> 21.10.2018 22:54 UTC Внутренние системы мониторинга начали указывать на многочисленные сбои в системах. <br> 21.10.2018 23:02 UTC Инженеры определили, что состояние кластера БД не соответствует ожиданиям. Топология репликации включала только Западный ЦОД. <br> 21.10.2018 23:07 UTC Ответственная команда заблокировала внутренние деплойменты, чтобы предотвратить внесение новых изменений. <br> 21.10.2018 23:09 UTC Ситуация переведена в статус активного инцидента (повышенный уровень ошибок). <br> 21.10.2018 23:11 UTC Статус инцидента переведен в красный - недоступность сервиса. <br> 21.10.2018 23:13 UTC Было понятно, что проблема затронула несколько кластеров БД. Были вызваны инженеры из группы разработки БД GitHub. Они начали исследовать, какие действия необходимо предпринять, чтобы вручную настроить БД Восточного ЦОД и перестроить топологию репликации. К этому моменту кластер БД Восточного ЦОД уже почти 40 минут принимал записи. Кроме того, в кластере Восточного ЦОД существовало несколько секунд записей, которые не были реплицированы на Западный ЦОД. <br> 21.10.2018 23:19 UTC Выбирая между целостностью данных и удобством пользования, GitHub решил остановить работу веб-хуков и GitHub Pages. <br> 22.10.2018 00:05 UTC Принято решение восстановить кластера из резервных копий, синхронизировать реплики на обоих ЦОД, вернуться к стабильной топологии обслуживания, а затем возобновить обработку джобов. Проинформировали пользователей, что планируется выполнить контролируемый переход на другой ресурс внутренней системы хранения данных. Время, необходимое для восстановления нескольких Тб данных резервной копии, привело к тому, что процесс занял несколько часов. Процесс распаковки, расчета контрольной суммы, подготовки и загрузки больших файлов резервных копий занял большую часть времени. Сроки восстановления были хорошо известны заранее, но до этого инцидента никогда не приходилось полностью восстанавливать весь кластер из резервной копии. <br> 22.10.2018 00:41 UTC Инициирован процесс резервного копирования для всех затронутых кластеров MySQL. Одновременно несколько групп инженеров искали способы ускорить передачу и время восстановления без дальнейшего ухудшения удобства использования сайта или риска повреждения данных. <br> 22.10.2018 06:51 UTC Несколько кластеров завершили восстановление из резервных копий в Восточном ЦОД и начали репликацию новых данных с Западного. Более крупные кластеры БД все еще восстанавливались. Пользователям сообщили, что до полного восстановления осталось два часа. <br> 22.10.2018 07:46 UTC GitHub опубликовал сообщение в блоге, чтобы предоставить больше информации. <br> 22.10.2018 11:12 UTC В Восточном ЦОД восстановлены первичные БД. По-прежнему оставались десятки реплик БД, которые отставали от основной на несколько часов. Отложенные реплики приводили к тому, что пользователи видели несогласованные данные. Из-за увеличения нагрузки записи на кластеры БД, когда пользователи начинали свой рабочий день в Европе и США, процесс восстановления занял больше времени, чем первоначально предполагалось. <br> 22.10.2018 13:15 UTC Стало ясно, что задержки репликации увеличиваются, а не уменьшаются в направлении согласованного состояния. Решили предоставлять дополнительные реплики чтения MySQL в Восточном ЦОД. <br> 22.10.2018 16:24 UTC Реплики были синхронизированы, выполнено переключение на исходную топологию. <br> 22.10.2018 16:45 UTC В очереди было более пяти миллионов вебхуков и 80 тысяч сборок страниц. <br> 22.10.2018 23:03 UTC Все ожидающие сборки вебхуков и страниц были обработаны, и была подтверждена целостность и правильная работа всех систем. |
| Последующие действия   |Собраны логи записей, которые не были реплицированы. <br> Настроена конфигурация Orchestrator для предотвращения повторения инцидента. <br>Принято решение устанавливать статусы не работе всего Github, а отдельным сервисам, чтобы лучше информировать пользователей, что не работает в текущий момент.<br> Поставили цель — допустить полный отказ одного ЦОД без воздействия на пользователя. <br>Решили применять практику проверки сценариев сбоев: инвестиции в инструменты внедрения ошибок и хаос-инжиниринга.    |
